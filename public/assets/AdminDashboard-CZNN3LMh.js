import{r as n,b as i,j as e,D as x}from"./index-2MA6xvft.js";import{o as v}from"./offline-CafmH5fM.js";import{a as V}from"./download-BK1hkIUJ.js";function me(){const[l,g]=n.useState([]),[b,w]=n.useState([]),[c,Y]=n.useState([]),[z,C]=n.useState([]),[I,H]=n.useState([]),[_,D]=n.useState([]),[u,L]=n.useState({from:"",to:""}),[d,$]=n.useState({year:"",branch:""}),[a,E]=n.useState(null),[j,h]=n.useState(""),[q,p]=n.useState("success"),[k,U]=n.useState(""),[m,P]=n.useState({year:"",branch:""}),[f,B]=n.useState(!1),r=async()=>{B(!0);try{const[t,s,o,M,T,ne]=await Promise.all([i.get("/admin/students/pending"),i.get("/admin/security/pending"),i.get("/admin/admins/pending"),i.get("/admin/students"),i.get("/admin/logs",{params:u.from||u.to?{...u}:{}}),i.get("/admin/users",{params:{role:"security",approvedOnly:!0}})]);g(t.data),w(s.data),Y(o.data),C(M.data),D(T.data),H(ne.data),v.saveStudents(M.data).catch(()=>{}),v.saveLogs(T.data).catch(()=>{});try{const le=(await i.get("/admin/visitors")).data;v.saveVisitors(le).catch(()=>{})}catch{}}catch{const[s,o]=await Promise.all([v.loadStudents().catch(()=>[]),v.loadLogs().catch(()=>[])]);s.length&&C(s),o.length&&D(o),h("Offline mode: showing cached data"),p("error")}B(!1)};n.useEffect(()=>{(async()=>{try{const{data:t}=await i.get("/auth/me");E(t),t!=null&&t.isApproved&&await r()}catch{}})()},[]),n.useEffect(()=>{if(!j)return;const t=setTimeout(()=>h(""),2e3);return()=>clearTimeout(t)},[j]);const X=async t=>{await i.post(`/admin/students/${t}/approve`),await r()},W=async t=>{await i.post(`/admin/students/${t}/decline`),await r()},Q=async t=>{await i.post(`/admin/security/${t}/approve`),await r()},G=async t=>{await i.post(`/admin/security/${t}/decline`),await r()},J=async t=>{await i.post(`/admin/admins/${t}/approve`),await r()},K=async t=>{await i.post(`/admin/admins/${t}/decline`),await r()},Z=async()=>{var o;if(!confirm("Approve all pending students (filtered)? Pins and QR will be generated automatically."))return;const t={batchYear:m.year?Number(m.year):void 0,branch:m.branch||void 0},s=await i.post("/admin/students/approve-all",t);h(`${((o=s.data)==null?void 0:o.approved)||0} students approved`),p("success"),await r()},ee=async()=>{var o;if(!confirm("Reject all pending students (filtered)?"))return;const t={batchYear:m.year?Number(m.year):void 0,branch:m.branch||void 0},s=await i.post("/admin/students/decline-all",t);h(`${((o=s.data)==null?void 0:o.declined)||0} students rejected`),p("success"),await r()},y=async(t,s)=>{try{await V(`/api/export/${t}`,{type:s,from:u.from||void 0,to:u.to||void 0},`${s}-logs.${t}`)}catch(o){h(o.message||"Export failed"),p("error")}},R=async t=>{try{const s={type:"student-details",batchYear:d.year||void 0,branch:d.branch||void 0},o=`student-details${d.year?"-"+d.year:""}${d.branch?"-"+d.branch:""}.${t}`;await V(`/api/export/${t}`,s,o)}catch(s){h(s.message||"Export failed"),p("error")}},te=async()=>{if(!confirm("This will permanently delete logs and visitors older than the cutoff. Continue?"))return;const t=k?{before:k}:{months:3},{data:s}=await i.post("/admin/purge-old",t);h(`Deleted ${s.deletedLogs} logs and ${s.deletedVisitors} visitors (<= ${new Date(s.cutoff).toLocaleDateString()})`),p("success"),await r()},se=async t=>{confirm("Delete this student permanently?")&&(await i.delete(`/admin/students/${t}`),await r())},ae=async t=>{confirm("Delete this security user permanently?")&&(await i.delete(`/admin/security/${t}`),await r())},ie=async()=>{const{year:t,branch:s}=d;if(!t)return alert("Select a batch year");confirm(`Delete all students from batch ${t}${s?" ("+s+")":""}?`)&&(await i.post("/admin/students/batch-delete",{batchYear:Number(t),branch:s||void 0}),await r())};return e.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:"Admin Dashboard"}),a&&!a.isApproved&&!a.requestedApproval&&e.jsxs("div",{className:"rounded border border-red-200 bg-red-50 text-red-800 p-4 flex items-start gap-3",children:[e.jsx("div",{className:"font-semibold",children:"Application was rejected"}),e.jsx("div",{className:"ml-auto",children:e.jsx("button",{className:"btn",onClick:async()=>{await i.post("/auth/admin/request-approval"),E({...a,requestedApproval:!0}),h("Request sent"),p("success")},children:"Send request again"})})]}),a&&!a.isApproved&&a.requestedApproval&&e.jsx("div",{className:"rounded border border-blue-200 bg-blue-50 text-blue-800 p-3",children:"Application submitted — please wait for admin approval."}),j&&e.jsx("div",{role:"alert",className:`fixed top-4 right-4 z-50 shadow-lg rounded px-4 py-3 transition-opacity duration-300 ${q==="error"?"bg-red-600 text-white":"bg-green-600 text-white"}`,children:j}),(a==null?void 0:a.isApproved)&&l.length>0&&e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-2",children:[e.jsx("div",{className:"font-semibold",children:"Pending Student Approvals"}),e.jsxs("div",{className:"flex flex-wrap items-end gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Batch Year"}),e.jsxs("select",{className:"input",value:m.year,onChange:t=>P({...m,year:t.target.value}),children:[e.jsx("option",{value:"",children:"All"}),Array.from({length:31},(t,s)=>2020+s).map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Branch"}),e.jsxs("select",{className:"input",value:m.branch,onChange:t=>P({...m,branch:t.target.value}),children:[e.jsx("option",{value:"",children:"All"}),["CSE","Civil","Mechanical","EEE","FPP"].map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("button",{className:"inline-flex items-center gap-1.5 rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2",onClick:Z,title:"Approve all",children:[e.jsx(F,{className:"h-4 w-4"}),"Approve All"]}),e.jsxs("button",{className:"inline-flex items-center gap-1.5 rounded-md bg-rose-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 focus-visible:ring-offset-2",onClick:ee,title:"Reject all",children:[e.jsx(O,{className:"h-4 w-4"}),"Reject All"]})]})]}),e.jsx(x,{maxHeight:"60vh",columns:[{key:"registrationNo",title:"Reg No"},{key:"branch",title:"Branch"},{key:"batchYear",title:"Batch"},{key:"action",title:"Action",render:(t,s)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{onClick:()=>X(s.id)}),e.jsx(S,{onClick:()=>W(s.id)})]})}],data:l})]}),(a==null?void 0:a.isApproved)&&b.length>0&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Pending Security Approvals"}),e.jsx(x,{columns:[{key:"name",title:"Name"},{key:"registrationNo",title:"Identifier"},{key:"action",title:"Action",render:(t,s)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{onClick:()=>Q(s.id)}),e.jsx(S,{onClick:()=>G(s.id)})]})}],data:b})]}),(a==null?void 0:a.isApproved)&&c.length>0&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Pending Admin Approvals"}),e.jsx(x,{columns:[{key:"name",title:"Name"},{key:"registrationNo",title:"Identifier"},{key:"action",title:"Action",render:(t,s)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{onClick:()=>J(s.id)}),e.jsx(S,{onClick:()=>K(s.id)})]})}],data:c})]}),(a==null?void 0:a.isApproved)&&e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-2",children:[e.jsx("div",{className:"font-semibold",children:"Students"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Batch Year"}),e.jsxs("select",{className:"input",value:d.year,onChange:t=>$({...d,year:t.target.value}),children:[e.jsx("option",{value:"",children:"Select year"}),Array.from({length:31},(t,s)=>2020+s).map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Branch (optional)"}),e.jsxs("select",{className:"input",value:d.branch,onChange:t=>$({...d,branch:t.target.value}),children:[e.jsx("option",{value:"",children:"All"}),["CSE","Civil","Mechanical","EEE","FPP"].map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("button",{className:"inline-flex items-center justify-center gap-1.5 rounded-md bg-amber-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-amber-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-500 focus-visible:ring-offset-2 active:bg-amber-800 transition",onClick:ie,title:"Batch delete",children:[e.jsx(N,{className:"h-4 w-4"}),"Batch Delete"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>R("pdf"),children:"Export Students PDF"}),e.jsx("button",{className:"btn",onClick:()=>R("docx"),children:"Export Students DOCX"})]})]})]}),e.jsx(x,{maxHeight:"60vh",columns:[{key:"registrationNo",title:"Reg No"},{key:"name",title:"Name"},{key:"branch",title:"Branch"},{key:"batchYear",title:"Batch"},{key:"action",title:"Action",render:(t,s)=>e.jsxs("button",{className:"inline-flex items-center gap-1.5 rounded-md bg-rose-600 px-3 py-1 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 focus-visible:ring-offset-2",onClick:()=>se(s.id),title:"Delete student",children:[e.jsx(N,{className:"h-4 w-4"}),"Delete"]})}],data:z})]}),(a==null?void 0:a.isApproved)&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("div",{className:"font-semibold",children:"Security Users"})}),e.jsx(x,{maxHeight:"50vh",columns:[{key:"registrationNo",title:"Identifier"},{key:"name",title:"Name"},{key:"action",title:"Action",render:(t,s)=>e.jsxs("button",{className:"inline-flex items-center gap-1.5 rounded-md bg-rose-600 px-3 py-1 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 focus-visible:ring-offset-2",onClick:()=>ae(s.id),title:"Delete security user",children:[e.jsx(N,{className:"h-4 w-4"}),"Delete"]})}],data:I})]}),(a==null?void 0:a.isApproved)&&e.jsxs("div",{className:"card space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"From"}),e.jsx("input",{type:"datetime-local",className:"input",value:u.from,onChange:t=>L({...u,from:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"To"}),e.jsx("input",{type:"datetime-local",className:"input",value:u.to,onChange:t=>L({...u,to:t.target.value})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`btn ${f?"opacity-70 cursor-not-allowed":""}`,disabled:f,onClick:r,children:f?"Loading…":"Filter"}),e.jsx("button",{className:"btn",disabled:f,onClick:()=>y("pdf","students"),children:"Export PDF"}),e.jsx("button",{className:"btn",disabled:f,onClick:()=>y("docx","students"),children:"Export DOCX"})]})]}),f?e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 dark:text-gray-300",children:[e.jsxs("svg",{className:"h-5 w-5 animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 3v3",strokeLinecap:"round"}),e.jsx("path",{d:"M12 18v3",strokeLinecap:"round"}),e.jsx("path",{d:"M3 12h3",strokeLinecap:"round"}),e.jsx("path",{d:"M18 12h3",strokeLinecap:"round"})]}),"Loading data…"]}):e.jsx(x,{maxHeight:"60vh",columns:[{key:"registrationNo",title:"Reg No"},{key:"name",title:"Name"},{key:"branch",title:"Branch"},{key:"batchYear",title:"Batch"},{key:"action",title:"Action"},{key:"purpose",title:"Purpose"},{key:"checkInTime",title:"Check-in",render:t=>t?new Date(t).toLocaleString():"-"},{key:"checkOutTime",title:"Check-out",render:t=>t?new Date(t).toLocaleString():"-"}],data:_})]}),(a==null?void 0:a.isApproved)&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Visitor Logs"}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("button",{className:"btn",onClick:()=>y("pdf","visitors"),children:"Export PDF"}),e.jsx("button",{className:"btn",onClick:()=>y("docx","visitors"),children:"Export DOCX"})]}),e.jsx(re,{})]}),(a==null?void 0:a.isApproved)&&e.jsx("div",{className:"card",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Purge Old Data"}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Delete student check-in/out logs and visitor logs older than 3 months (or a custom date)."})]}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Custom cutoff (optional)"}),e.jsx("input",{type:"date",className:"input",value:k,onChange:t=>U(t.target.value)})]}),e.jsxs("button",{className:"inline-flex items-center gap-1.5 rounded-md bg-rose-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 focus-visible:ring-offset-2",onClick:te,title:"Permanently delete old data",children:[e.jsx(N,{className:"h-4 w-4"}),"Purge Old Data"]})]})]})})]})}function re(){const[l,g]=n.useState([]),[b,w]=n.useState(!0);return n.useEffect(()=>{(async()=>{try{const c=await i.get("/admin/visitors");g(c.data),v.saveVisitors(c.data).catch(()=>{})}catch{const c=await v.loadVisitors().catch(()=>[]);g(c)}finally{w(!1)}})()},[]),b?e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 dark:text-gray-300",children:[e.jsxs("svg",{className:"h-5 w-5 animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 3v3",strokeLinecap:"round"}),e.jsx("path",{d:"M12 18v3",strokeLinecap:"round"}),e.jsx("path",{d:"M3 12h3",strokeLinecap:"round"}),e.jsx("path",{d:"M18 12h3",strokeLinecap:"round"})]}),"Loading visitors…"]}):e.jsx(x,{maxHeight:"50vh",columns:[{key:"name",title:"Name"},{key:"vehicleNo",title:"Vehicle"},{key:"purpose",title:"Purpose"},{key:"entryTime",title:"Entry",render:c=>new Date(c).toLocaleString()},{key:"exitTime",title:"Exit",render:c=>c?new Date(c).toLocaleString():"-"}],data:l})}function A({onClick:l}){return e.jsxs("button",{type:"button",onClick:l,className:"inline-flex items-center gap-1.5 rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 active:bg-emerald-800 transition","aria-label":"Approve",title:"Approve",children:[e.jsx(F,{className:"h-4 w-4"}),"Approve"]})}function S({onClick:l}){return e.jsxs("button",{type:"button",onClick:l,className:"inline-flex items-center gap-1.5 rounded-md bg-rose-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 focus-visible:ring-offset-2 active:bg-rose-800 transition","aria-label":"Reject",title:"Reject",children:[e.jsx(O,{className:"h-4 w-4"}),"Reject"]})}function F({className:l=""}){return e.jsx("svg",{className:l,viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true",children:e.jsx("path",{fillRule:"evenodd",d:"M16.704 5.29a1 1 0 010 1.42l-7.5 7.5a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.42l2.293 2.293 6.793-6.793a1 1 0 011.414 0z",clipRule:"evenodd"})})}function O({className:l=""}){return e.jsx("svg",{className:l,viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})}function N({className:l=""}){return e.jsxs("svg",{className:l,viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true",children:[e.jsx("path",{d:"M6 7a1 1 0 011 1v7a1 1 0 11-2 0V8a1 1 0 011-1zm4 0a1 1 0 011 1v7a1 1 0 11-2 0V8a1 1 0 011-1zm4 0a1 1 0 011 1v7a1 1 0 11-2 0V8a1 1 0 011-1z"}),e.jsx("path",{fillRule:"evenodd",d:"M4 5a2 2 0 012-2h8a2 2 0 012 2v1H4V5zm2-1a1 1 0 00-1 1v1h10V5a1 1 0 00-1-1H6z",clipRule:"evenodd"})]})}export{me as default};
